var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _crypto=_interopRequireDefault(require("crypto"));var _async=_interopRequireDefault(require("async"));var _keystone=_interopRequireDefault(require("keystone"));var _keystoneEmail=_interopRequireDefault(require("keystone-email"));var _this=this;var Types=_keystone.default.Field.Types;var User=new _keystone.default.List('User',{track:true,autokey:{path:'key',from:'name',unique:true}});var deps={mentoring:{'mentoring.available':true},github:{'services.github.isConfigured':true},facebook:{'services.facebook.isConfigured':true},google:{'services.google.isConfigured':true},twitter:{'services.twitter.isConfigured':true}};User.add({name:{type:Types.Name,required:true,index:true},email:{type:Types.Email,initial:true,index:true},password:{type:Types.Password,initial:true},resetPasswordKey:{type:String,hidden:true}},'Profile',{isPublic:{type:Boolean,default:true},isOrganiser:Boolean,isGroup:Boolean,github:{type:String,width:'short'},twitter:{type:String,width:'short'},website:{type:Types.Url},bio:{type:Types.Markdown},gravatar:{type:String,noedit:true}},'Notifications',{notifications:{posts:{type:Boolean},meetups:{type:Boolean,default:true}}},'Mentoring',{mentoring:{available:{type:Boolean,label:'Is Available',index:true},free:{type:Boolean,label:'For Free',dependsOn:deps.mentoring},paid:{type:Boolean,label:'For Payment',dependsOn:deps.mentoring},swap:{type:Boolean,label:'For Swap',dependsOn:deps.mentoring},have:{type:String,label:'Has...',dependsOn:deps.mentoring},want:{type:String,label:'Wants...',dependsOn:deps.mentoring}}},'Permissions',{isAdmin:{type:Boolean,label:'Can Admin SydJS'},isVerified:{type:Boolean,label:'Has a verified email address'}},'Services',{services:{github:{isConfigured:{type:Boolean,label:'GitHub has been authenticated'},profileId:{type:String,label:'Profile ID',dependsOn:deps.github},username:{type:String,label:'Username',dependsOn:deps.github},avatar:{type:String,label:'Image',dependsOn:deps.github},accessToken:{type:String,label:'Access Token',dependsOn:deps.github},refreshToken:{type:String,label:'Refresh Token',dependsOn:deps.github}},facebook:{isConfigured:{type:Boolean,label:'Facebook has been authenticated'},profileId:{type:String,label:'Profile ID',dependsOn:deps.facebook},username:{type:String,label:'Username',dependsOn:deps.facebook},avatar:{type:String,label:'Image',dependsOn:deps.facebook},accessToken:{type:String,label:'Access Token',dependsOn:deps.facebook},refreshToken:{type:String,label:'Refresh Token',dependsOn:deps.facebook}},google:{isConfigured:{type:Boolean,label:'Google has been authenticated'},profileId:{type:String,label:'Profile ID',dependsOn:deps.google},username:{type:String,label:'Username',dependsOn:deps.google},avatar:{type:String,label:'Image',dependsOn:deps.google},accessToken:{type:String,label:'Access Token',dependsOn:deps.google},refreshToken:{type:String,label:'Refresh Token',dependsOn:deps.google}},twitter:{isConfigured:{type:Boolean,label:'Twitter has been authenticated'},profileId:{type:String,label:'Profile ID',dependsOn:deps.twitter},username:{type:String,label:'Username',dependsOn:deps.twitter},avatar:{type:String,label:'Image',dependsOn:deps.twitter},accessToken:{type:String,label:'Access Token',dependsOn:deps.twitter},refreshToken:{type:String,label:'Refresh Token',dependsOn:deps.twitter}}}},'Meta',{talkCount:{type:Number,default:0,noedit:true},lastRSVP:{type:Date,noedit:true}});User.schema.pre('save',function(next){var member=_this;_async.default.parallel([function(done){if(!member.email)return done();member.gravatar=_crypto.default.createHash('md5').update(member.email.toLowerCase().trim()).digest('hex');return done();}],next);});User.schema.virtual('url').get(function(){return"/member/"+_this.key;});User.schema.virtual('canAccessKeystone').get(function(){return _this.isAdmin;});User.schema.virtual('avatarUrl').get(function(){if(_this.photo.exists)return _this._.photo.thumbnail(120,120);if(_this.services.github.isConfigured&&_this.services.github.avatar){return _this.services.github.avatar;}if(_this.services.facebook.isConfigured&&_this.services.facebook.avatar){return _this.services.facebook.avatar;}if(_this.services.google.isConfigured&&_this.services.google.avatar){return _this.services.google.avatar;}if(_this.services.twitter.isConfigured&&_this.services.twitter.avatar){return _this.services.twitter.avatar;}if(_this.gravatar){return"https://www.gravatar.com/avatar/"+_this.gravatar+"?d=https%3A%2F%2Fsydjs.com%2Fimages%2Favatar.png&r=pg";}});User.schema.virtual('twitterUsername').get(function(){return _this.services.twitter&&_this.services.twitter.isConfigured?_this.services.twitter.username:'';});User.schema.virtual('githubUsername').get(function(){return _this.services.github&&_this.services.github.isConfigured?_this.services.github.username:'';});User.schema.methods.resetPassword=function(callback){var user=_this;user.resetPasswordKey=_keystone.default.utils.randomString([16,24]);user.save(function(err){if(err)return callback(err);new _keystoneEmail.default('forgotten-password',{transport:'mandrill',engine:'jade',root:'templates/emails'}).send({user:user,link:"/reset-password/"+user.resetPasswordKey,host:'http://www.sydjs.com'},{subject:'Reset your SydJS Password',to:user.email,from:{name:'SydJS',email:'contact@sydjs.com'}},callback);});};User.defaultColumns='name, email, twitter, isAdmin';User.register();